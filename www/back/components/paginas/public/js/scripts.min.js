var j = jQuery.noConflict();

function handleSaveLayout() {
    var e = j(".demo").html();
    if (e != window.demoHtml) {
        saveLayout();
        window.demoHtml = e
    }
}
function handleJsIds() {
    handleModalIds();
    handleAccordionIds();
    handleCarouselIds();
    handleTabsIds()
}
function handleAccordionIds() {
    var e = j(".demo #myAccordion");
    var t = randomNumber();
    var n = "panel-" + t;
    var r;
    e.attr("id", n);
    e.find(".panel").each(function(e, t) {
        r = "panel-element-" + randomNumber();
        j(t).find(".panel-title").each(function(e, t) {
            j(t).attr("data-parent", "#" + n);
            j(t).attr("href", "#" + r)
        });
        j(t).find(".panel-collapse").each(function(e, t) {
            j(t).attr("id", r)
        })
    })
}
function handleCarouselIds() {
    var e = j(".demo #myCarousel");
    var t = randomNumber();
    var n = "carousel-" + t;
    e.attr("id", n);
    e.find(".carousel-indicators li").each(function(e, t) {
        j(t).attr("data-target", "#" + n)
    });
    e.find(".left").attr("href", "#" + n);
    e.find(".right").attr("href", "#" + n)
}
function handleModalIds() {
    var e = j(".demo #myModalLink");
    var t = randomNumber();
    var n = "modal-container-" + t;
    var r = "modal-" + t;
    e.attr("id", r);
    e.attr("href", "#" + n);
    e.next().attr("id", n)
}
function handleTabsIds() {
    var e = j(".demo #myTabs");
    var t = randomNumber();
    var n = "tabs-" + t;
    e.attr("id", n);
    e.find(".tab-pane").each(function(e, t) {
        var n = j(t).attr("id");
        var r = "panel-" + randomNumber();
        j(t).attr("id", r);
        j(t).parent().parent().find("a[href=#" + n + "]").attr("href", "#" + r)
    })
}
function randomNumber() {
    return randomFromInterval(1, 1e6)
}
function randomFromInterval(e, t) {
    return Math.floor(Math.random() * (t - e + 1) + e)
}
function gridSystemGenerator() {
    j(".lyrow .preview input").bind("keyup", function() {
        var e = 0;
        var t = "";
        var n = false;
        var r = j(this).val().split(" ", 12);
        j.each(r, function(r, i) {
            if (!n) {
                if (parseInt(i) <= 0)
                    n = true;
                e = e + parseInt(i);
                t += '<div class="col-md-' + i + ' column"></div>'
            }
        });
        if (e == 12 && !n) {
            j(this).parent().next().children().html(t);
            j(this).parent().prev().show()
        } else {
            j(this).parent().prev().hide()
        }
        actualizaEventos();
    })
}
function configurationElm(e, t) {
    j(".demo").delegate(".configuration > a", "click", function(e) {
        e.preventDefault();
        var t = j(this).parent().next().next().children();
        j(this).toggleClass("active");
        t.toggleClass(j(this).attr("rel"))
    });
    j(".demo").delegate(".configuration .dropdown-menu a", "click", function(e) {
        e.preventDefault();
        var t = j(this).parent().parent();
        var n = t.parent().parent().next().next().children();
        t.find("li").removeClass("active");
        j(this).parent().addClass("active");
        var r = "";
        t.find("a").each(function() {
            r += j(this).attr("rel") + " "
        });
        t.parent().removeClass("open");
        n.removeClass(r);
        n.addClass(j(this).attr("rel"))
    })
    
}
function removeElm() {
    j(".demo").delegate(".remove", "click", function(e) {
        e.preventDefault();
        j(this).parent().remove();
        if (!j(".demo .lyrow").length > 0) {
            clearDemo()
        }
    })
}
function clearDemo() {
    j(".demo").empty()
}
function removeMenuClasses() {
    j("#menu-layoutit li button").removeClass("active")
}
function changeStructure(e, t) {
    j("#download-layout ." + e).removeClass(e).addClass(t)
}
function cleanHtml(e) {
    j(e).parent().append(j(e).children().html())
}
function downloadLayoutSrc() {
    
    var original = j(".demo").html();
    j("#download-layout").children().html(j(".demo").html());
    var t = j("#download-layout").children();
    t.find(".preview, .configuration, .drag, .remove").remove();
    t.find(".lyrow").addClass("removeClean");
    t.find(".box-element").addClass("removeClean");
    t.find(".lyrow .lyrow .lyrow .lyrow .lyrow .removeClean").each(function() {
        cleanHtml(this)
    });
    t.find(".lyrow .lyrow .lyrow .lyrow .removeClean").each(function() {
        cleanHtml(this)
    });
    t.find(".lyrow .lyrow .lyrow .removeClean").each(function() {
        cleanHtml(this)
    });
    t.find(".lyrow .lyrow .removeClean").each(function() {
        cleanHtml(this)
    });
    t.find(".lyrow .removeClean").each(function() {
        cleanHtml(this)
    });
    t.find(".removeClean").each(function() {
        cleanHtml(this)
    });
    t.find(".removeClean").remove();
    j("#download-layout .column").removeClass("ui-sortable");
    j("#download-layout .row-fluid").removeClass("clearfix").children().removeClass("column");
    if (j("#download-layout .container").length > 0) {
        changeStructure("row-fluid", "row")
    }
    formatSrc = j.htmlClean(j("#download-layout").html(), {format: true, allowedAttributes: [["id"], ["class"],["style"],["target"], ["data-toggle"], ["data-target"], ["data-parent"], ["role"], ["data-dismiss"], ["aria-labelledby"], ["aria-hidden"], ["data-slide-to"], ["data-slide"]]});
    j("#download-layout").html(formatSrc);
    j("#downloadModal textarea").empty();
    j("#downloadModal textarea").val(formatSrc)
    
    var a = parent.location.pathname.split("/");
    var id=0;
        if (a.length>3) 
            id = a[5];
    
    var b = parent.location.pathname.split("/");
    
    b = b[0] + '/' +  b[1] + '/' +  b[2] + '/' +  b[3] + '/guardar';
      j.post(b,
             { html: formatSrc,  id:  id , original: original},
            function(data, textStatus, jqXHR){
                if(data)
                    alertify.success("Se ha guardado correctamente la p치gina!!!");
                else
                    alertify.success("Hubo un problema con la p치gina!!!");

            }).fail(function(jqXHR, textStatus, errorThrown) {
                        alertify.error(textStatus);
             });

    
    
    
}


function actualizaEventos(){
    
    j(document).delegate('.editable','click',function(){
        //console.log('hizo click en editbale');
        Aloha.ready( function() {
            Aloha.jQuery('.editable').aloha();
        });        
    });  
}
   
var currentDocument = null;
var timerSave = 2e3;
var demoHtml = j(".demo").html();
j(window).resize(function() {
    j("body").css("min-height", j(window).height() - 90);
    j(".demo").css("min-height", j(window).height() - 160)
});
j(document).ready(function() {
    var a = parent.location.pathname.split("/");
    var id=0;
        if (a.length>3) 
            id = a[5];

        j.get( "../../../../paginas/maquetacion/getoriginal/" + id + "/", function( data ) {
       
        j( ".demo" ).html(data);

        actualizaEventos();
        inicializaEditor();
        alertify.success( "Se carg칩 correctamente su p치gina!" );
        
      });
    
})


function inicializaEditor(){
    
    j("body").css("min-height", j(window).height() - 90);
    j(".demo").css("min-height", j(window).height() - 160);
    j(".demo, .demo .column").sortable({connectWith: ".column", opacity: .35, handle: ".drag"});
    j(".sidebar-nav .lyrow").draggable({connectToSortable: ".demo", helper: "clone", handle: ".drag", drag: function(e, t) {
            t.helper.width(400)
        }, stop: function(e, t) {
            j(".demo .column").sortable({opacity: .35, connectWith: ".column"})
        }});
    j(".sidebar-nav .box").draggable({connectToSortable: ".column", helper: "clone", handle: ".drag", drag: function(e, t) {
            t.helper.width(400)
        }, stop: function() {
            handleJsIds()
        }});
    j("[data-target=#downloadModal]").click(function(e) {
        e.preventDefault();
        downloadLayoutSrc()
    });
    j("#download").click(function() {
        downloadLayout();
        return false
    });
    j("#downloadhtml").click(function() {
        downloadHtmlLayout();
        return false
    });

    var clicked = false;
    j("#fullscreen").click(function() {
        
        //  alert(clicked);
        if (clicked) {
            j("#wrapper", parent.document).css('padding-left', '');
            j("#sidebar-wrapper", parent.document).css('left', '');
            j(this).removeClass("active").css("background", "");
            clicked = false;
            exit;
        }
        else {
            j("#wrapper", parent.document).css('padding-left', '0');
            j("#sidebar-wrapper", parent.document).css('left', '0');
            j(this).addClass("active").css("background", "#D83526");
            clicked = true;
        }
        
        return false
    });
    j("#edit").click(function() {
        j("body").removeClass("devpreview sourcepreview");
        j("body").addClass("edit");
        removeMenuClasses();
        j(this).addClass("active");
        return false
    });
    j("#clear").click(function(e) {
        e.preventDefault();
        clearDemo()
    });
    j("#abrir").click(function(e){
       var a = parent.location.pathname.split("/");
       var pagina = a[6]; 
       var b = parent.location.href.split("/")
       var BASE_URL = b[2];
       window.open('http://' + BASE_URL + '/' + pagina);            
    });
    j("#devpreview").click(function() {
        j("body").removeClass("edit sourcepreview");
        j("body").addClass("devpreview");
        removeMenuClasses();
        j(this).addClass("active");
        return false
    });
    j("#sourcepreview").click(function() {
        j("body").removeClass("edit");
        j("body").addClass("devpreview sourcepreview");
        removeMenuClasses();
        j(this).addClass("active");
        return false
    });
    j(".nav-header").click(function() {
        j(".sidebar-nav .boxes, .sidebar-nav .rows").hide();
        j(this).next().slideDown()
    });
    removeElm();
    configurationElm();
    gridSystemGenerator();
    setInterval(function() {
        handleSaveLayout()
    }, timerSave)
}



